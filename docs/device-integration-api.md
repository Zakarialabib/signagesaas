# Device Integration Layer API Documentation

This document outlines the REST API endpoints for the Device Integration Layer, which enables communication between the SignageSaaS platform and edge devices (media players, Raspberry Pis, Android boxes, etc.).

## Overview

The Device Integration Layer provides the following core functionalities:

- **Device Authentication**: Secure token-based handshake mechanism
- **Content Synchronization**: API for syncing media to edge devices
- **OTA Updates**: Secure delivery of software updates via signed URLs
- **Status Reporting**: Real-time heartbeat ping system

## Authentication

All device API endpoints (except the authentication endpoint itself) require a valid device token for access.

### Device Authentication

```
POST /api/device/authenticate
```

**Request Body:**

```json
{
    "hardware_id": "unique-hardware-identifier",
    "tenant_id": "tenant-uuid"
}
```

**Response:**

```json
{
    "success": true,
    "token": "device-auth-token",
    "device_id": "device-uuid",
    "timestamp": "2023-06-15T12:34:56Z"
}
```

**Usage:**

After receiving the token, include it in all subsequent requests in the Authorization header:

```
Authorization: Bearer device-auth-token
```

## Heartbeat/Status Reporting

Devices should send regular heartbeat pings to report their status and receive instructions.

```
POST /api/device/heartbeat/{device_id}
```

**Request Body:**

```json
{
    "status": "online",
    "ip_address": "192.168.1.100",
    "metrics": {
        "cpu_usage": 23.5,
        "memory_usage": 512.6,
        "uptime": 86400
    },
    "app_version": "1.2.3",
    "screen_status": {
        "power": "on",
        "brightness": 80
    },
    "storage_info": {
        "total": 32000,
        "free": 15000
    },
    "network_info": {
        "type": "wifi",
        "signal_strength": 85
    },
    "system_info": {
        "os_version": "Android 11",
        "model": "Raspberry Pi 4"
    }
}
```

**Response:**

```json
{
    "success": true,
    "timestamp": "2023-06-15T12:34:56Z",
    "needs_sync": true
}
```

## Content Synchronization

Devices should sync content when instructed (when `needs_sync` is true in the heartbeat response).

```
GET /api/device/sync/{device_id}
```

**Response:**

```json
{
    "success": true,
    "device": {
        "id": "device-uuid",
        "name": "Lobby Display",
        "type": "android-box",
        "settings": {
            "volume": 70,
            "brightness": 80
        }
    },
    "screens": [
        {
            "screen_id": "screen-uuid",
            "screen_name": "Main Screen",
            "resolution": "1920x1080",
            "orientation": "landscape",
            "settings": {
                "transition": "fade"
            },
            "contents": [
                {
                    "id": "content-uuid",
                    "name": "Welcome Message",
                    "type": "html",
                    "content_data": {
                        /* content specific data */
                    },
                    "duration": 15,
                    "order": 1,
                    "settings": {
                        /* content specific settings */
                    },
                    "rendered_html": "<div>Welcome to our office</div>",
                    "media_url": "https://example.com/api/device/media/device-uuid/content-uuid?signature=xyz"
                }
            ]
        }
    ],
    "ota_update": {
        "version": "1.3.0",
        "download_url": "https://example.com/api/device/download/device-uuid?file=updates/android-box/v1.3.0.zip&signature=xyz",
        "checksum": "sha256-hash-of-update-file",
        "release_notes": "Bug fixes and performance improvements"
    },
    "timestamp": "2023-06-15T12:34:56Z"
}
```

## Media Download

Devices can download media files using the signed URLs provided in the sync response.

```
GET /api/device/media/{device_id}/{content_id}
```

This endpoint requires a valid signature generated by the server.

## OTA Updates

Devices can download OTA updates using the signed URLs provided in the sync response.

```
GET /api/device/download/{device_id}
```

This endpoint requires a valid signature generated by the server.

## Implementation Guidelines

### Recommended Polling Intervals

- **Heartbeat**: Every 30-60 seconds
- **Content Sync**: Only when `needs_sync` is true in heartbeat response
- **OTA Updates**: Automatically download when available in sync response

### Error Handling

Devices should implement exponential backoff for failed requests:

1. Start with a 5-second retry delay
2. Double the delay for each consecutive failure (max 5 minutes)
3. Reset delay after a successful request

### Security Considerations

- Always validate SSL certificates
- Never store the authentication token in plain text
- Verify checksums of downloaded OTA updates before installation

## Client SDK

For easier integration, we provide client SDKs for common platforms:

- Android: [Android SDK](../sdk/android/README.md) - Java/Kotlin SDK for Android-based signage devices
- Raspberry Pi (Python): [Raspberry Pi SDK](../sdk/raspberry-pi/README.md) - Python SDK for Raspberry Pi devices
- Windows (C#): [Windows SDK](../sdk/windows/README.md) - C# SDK for Windows-based signage players

## Testing

A sandbox environment is available for testing device integration:

```
https://sandbox.signagesaas.com/api/device/
```

Contact support for sandbox tenant credentials.
